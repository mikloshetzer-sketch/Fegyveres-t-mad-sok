<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OSINT Armed Attacks Map</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.default.css">

  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, Arial; background:#f2f2f2; }

    /* Normal header (not embed) */
    header{
      height: 110px;
      padding: 10px 12px;
      border-bottom: 1px solid #ddd;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      box-sizing:border-box;
      gap:12px;
      background:#f2f2f2;
    }
    .left{ display:flex; flex-direction:column; gap:4px; }
    .title{ font-size:18px; font-weight:800; line-height:1.1; }
    .subtitle{ font-size:12px; opacity:.8; }

    .right{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:14px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    select{ padding:6px 8px; font-size:14px; }

    #status{
      padding: 8px 12px;
      font-size: 13px;
      border-bottom: 1px solid #eee;
      background: #f2f2f2;
    }
    #status.ok{ color:#0a7a2f; }
    #status.err{ color:#b00020; }

    /* Layout */
    #content{
      height: calc(100% - 110px - 41px);
      display:flex;
      min-height: 0;
      position: relative;
    }
    #map{
      flex: 1 1 auto;
      min-width: 0;
      background:#111;
    }

    /* Right panel (normal mode) */
    #panel{
      width: 360px;
      border-left: 1px solid #e6e6e6;
      background: #fff;
      padding: 12px;
      box-sizing: border-box;
      overflow: auto;
    }

    /* Shared panel styles */
    .panel-title{ font-weight: 800; margin: 0 0 8px 0; font-size: 14px; }
    .small{ font-size: 12px; opacity: .75; line-height: 1.35; margin: 0 0 12px 0; }
    .stat{ display:flex; justify-content:space-between; gap:12px; font-size: 13px; margin: 6px 0; }
    .divider{ height:1px; background:#eee; margin: 12px 0; }
    .src-list { margin: 6px 0 0 0; padding-left: 18px; }
    .src-list li { margin: 4px 0; }
    .toplist{ margin: 8px 0 0 0; padding-left: 18px; }
    .toplist li{ margin: 4px 0; font-size: 13px; }
    .pill{
      display:inline-block;
      padding: 2px 8px;
      border: 1px solid #e6e6e6;
      border-radius: 999px;
      font-size: 12px;
      margin-left: 6px;
      opacity: .85;
      background:#fff;
    }

    /* EMBED MODE */
    body.embed header, body.embed #status { display:none; }
    body.embed #content { height: 100%; }

    /* Floating controls in embed mode */
    #embedControls{
      display:none;
      position:absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: rgba(255,255,255,0.94);
      border: 1px solid rgba(0,0,0,0.15);
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.18);
      backdrop-filter: blur(4px);
      max-width: calc(100% - 24px);
    }
    body.embed #embedControls{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    #embedControls select{
      padding: 6px 8px;
      font-size: 13px;
      border-radius: 10px;
    }

    #panelToggle{
      border: 1px solid rgba(0,0,0,0.15);
      background: rgba(255,255,255,0.94);
      border-radius: 10px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 13px;
    }

    /* Panel overlay in embed mode */
    body.embed #panel{
      position:absolute;
      top: 64px; /* controls alatt */
      right: 10px;
      width: 360px;
      max-height: calc(100% - 76px);
      border: 1px solid rgba(0,0,0,0.15);
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.18);
      overflow:auto;
      background: rgba(255,255,255,0.96);
      backdrop-filter: blur(4px);
    }
    body.embed #panel.hidden{ display:none; }

    /* Small iframe / mobile: make panel narrower */
    @media (max-width: 900px){
      body.embed #panel{ width: min(92vw, 360px); max-height: 55%; top: 64px; }
      body:not(.embed) #content{ flex-direction: column; }
      body:not(.embed) #panel{ width: 100%; border-left:none; border-top:1px solid #e6e6e6; }
    }
  </style>
</head>
<body>

<header>
  <div class="left">
    <div class="title">OSINT fegyveres incidensek t√©rk√©pe</div>
    <div class="subtitle">M≈±hold n√©zet ‚Ä¢ 2025: Q1‚ÄìQ4 ‚Ä¢ 2026: LIVE/RAW (14 nap) ‚Ä¢ r√©gi√≥ + statisztika</div>
  </div>

  <div class="right">
    <label>√âv:</label>
    <select id="yearSelect">
      <option value="2025" selected>2025</option>
      <option value="2026">2026</option>
    </select>

    <label id="quarterLabel">Negyed√©v:</label>
    <select id="quarterSelect">
      <option value="Q1">Q1</option>
      <option value="Q2">Q2</option>
      <option value="Q3">Q3</option>
      <option value="Q4" selected>Q4</option>
    </select>

    <label id="viewLabel" style="display:none;">N√©zet:</label>
    <select id="viewSelect" style="display:none;">
      <option value="live" selected>LIVE</option>
      <option value="raw">RAW</option>
    </select>

    <label>R√©gi√≥:</label>
    <select id="regionSelect">
      <option value="global" selected>Vil√°g</option>
      <option value="europe">Eur√≥pa</option>
      <option value="eastern_europe">Kelet-Eur√≥pa</option>
      <option value="balkans">Balk√°n</option>
      <option value="middle_east">K√∂zel-Kelet</option>
      <option value="north_africa">√âszak-Afrika</option>
      <option value="sub_saharan_africa">Szubszaharai Afrika</option>
      <option value="north_america">√âszak-Amerika</option>
      <option value="latin_america">Latin-Amerika</option>
      <option value="asia">√Åzsia</option>
      <option value="south_asia">D√©l-√Åzsia</option>
      <option value="east_asia">Kelet-√Åzsia</option>
      <option value="oceania">√ìce√°nia</option>
    </select>
  </div>
</header>

<div id="status">Bet√∂lt√©s‚Ä¶</div>

<div id="content">
  <!-- Embed floating controls -->
  <div id="embedControls">
    <button id="panelToggle" type="button">üìä Panel</button>

    <select id="yearSelectEmbed"></select>
    <select id="quarterSelectEmbed"></select>
    <select id="viewSelectEmbed"></select>
    <select id="regionSelectEmbed"></select>
  </div>

  <div id="map"></div>

  <aside id="panel">
    <div class="panel-title">√ñsszegz√©s</div>
    <div class="stat"><span><b>N√©zet</b></span><span id="statScope">-</span></div>
    <div class="stat"><span><b>R√©gi√≥</b></span><span id="statRegion">-</span></div>
    <div class="stat"><span><b>Pontok</b></span><span id="statPoints">-</span></div>
    <div class="stat"><span><b>Forr√°slinkek</b></span><span id="statSources">-</span></div>

    <div class="divider"></div>

    <div class="panel-title">T√°mad√°s t√≠pus szerinti bont√°s</div>
    <canvas id="typeChart" width="330" height="220"></canvas>

    <div class="divider"></div>

    <div class="panel-title">Top orsz√°gok (kiv√°lasztott r√©gi√≥ban)</div>
    <div class="small">Az orsz√°g mez≈ë a helysz√≠n sz√∂veg√©b≈ël (utols√≥ elem) van becs√ºlve, ez√©rt k√∂zel√≠t≈ë.</div>
    <ol class="toplist" id="topCountries"></ol>
  </aside>
</div>

<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
  const EMBED = new URLSearchParams(location.search).get("embed") === "1";
  if (EMBED) document.body.classList.add("embed");

  const statusEl = document.getElementById("status");

  // Main selects
  const yearSelect = document.getElementById("yearSelect");
  const quarterSelect = document.getElementById("quarterSelect");
  const quarterLabel = document.getElementById("quarterLabel");
  const viewSelect = document.getElementById("viewSelect");
  const viewLabel = document.getElementById("viewLabel");
  const regionSelect = document.getElementById("regionSelect");

  // Embed controls
  const embedControls = document.getElementById("embedControls");
  const panelToggle = document.getElementById("panelToggle");
  const yearSelectEmbed = document.getElementById("yearSelectEmbed");
  const quarterSelectEmbed = document.getElementById("quarterSelectEmbed");
  const viewSelectEmbed = document.getElementById("viewSelectEmbed");
  const regionSelectEmbed = document.getElementById("regionSelectEmbed");

  // Panel stats
  const statScope = document.getElementById("statScope");
  const statRegion = document.getElementById("statRegion");
  const statPoints = document.getElementById("statPoints");
  const statSources = document.getElementById("statSources");
  const topCountriesEl = document.getElementById("topCountries");
  const panel = document.getElementById("panel");

  function setStatusOk(msg){ statusEl.className="ok"; statusEl.textContent=msg; }
  function setStatusErr(msg){ statusEl.className="err"; statusEl.textContent=msg; }

  function escapeHtml(s) {
    return (s || "").toString()
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function getSources(p){
    const list = [];
    if (Array.isArray(p.sources)) {
      for (const u of p.sources) if (u && !list.includes(u)) list.push(u);
    }
    if (p.sourceurl && !list.includes(p.sourceurl)) list.push(p.sourceurl);
    return list;
  }

  function popupHtml(p){
    const date = escapeHtml(p.date || "-");
    const loc  = escapeHtml(p.location || "-");
    const type = escapeHtml(p.attack_type || "-");
    const sources = getSources(p);
    const sourcesCount =
      (typeof p.sources_count === "number") ? p.sources_count : sources.length;

    let srcHtml = `<div><b>Forr√°sok:</b> ${sourcesCount || 0}</div>`;
    if (sources.length){
      const items = sources.slice(0, 8).map((u,i)=>(
        `<li><a href="${u}" target="_blank" rel="noopener">Forr√°s ${i+1}</a></li>`
      )).join("");
      srcHtml += `<ul class="src-list">${items}</ul>`;
    }

    return `<b>Esem√©ny</b><br>
      D√°tum: ${date}<br>
      Helysz√≠n: ${loc}<br>
      T√≠pus: ${type}<br>
      ${srcHtml}`;
  }

  const REGIONS = {
    global:null,
    europe:{latMin:35,latMax:72,lonMin:-25,lonMax:45},
    eastern_europe:{latMin:44,latMax:65,lonMin:20,lonMax:60},
    balkans:{latMin:37,latMax:48,lonMin:13,lonMax:30},
    middle_east:{latMin:12,latMax:42,lonMin:25,lonMax:70},
    north_africa:{latMin:15,latMax:37,lonMin:-20,lonMax:40},
    sub_saharan_africa:{latMin:-35,latMax:15,lonMin:-20,lonMax:55},
    north_america:{latMin:7,latMax:75,lonMin:-170,lonMax:-50},
    latin_america:{latMin:-60,latMax:33,lonMin:-120,lonMax:-30},
    asia:{latMin:5,latMax:80,lonMin:45,lonMax:180},
    south_asia:{latMin:5,latMax:35,lonMin:60,lonMax:100},
    east_asia:{latMin:18,latMax:55,lonMin:100,lonMax:150},
    oceania:{latMin:-50,latMax:5,lonMin:110,lonMax:180},
  };

  function regionLabel(sel){
    const opt = sel.options[sel.selectedIndex];
    return opt ? opt.textContent : "-";
  }

  function scopeLabel(){
    const year = yearSelect.value;
    if (year === "2025") return `2025 ${quarterSelect.value}`;
    return `2026 ${viewSelect.value === "raw" ? "RAW" : "LIVE"}`;
  }

  function setControls(){
    const is2025 = yearSelect.value === "2025";
    quarterSelect.style.display = is2025 ? "" : "none";
    quarterLabel.style.display  = is2025 ? "" : "none";
    viewSelect.style.display    = is2025 ? "none" : "";
    viewLabel.style.display     = is2025 ? "none" : "";

    // Embed selects visibility
    if (EMBED){
      quarterSelectEmbed.style.display = is2025 ? "" : "none";
      viewSelectEmbed.style.display    = is2025 ? "none" : "";
    }
  }

  function dataUrl(){
    const year = yearSelect.value;
    if (year === "2025"){
      return `./data/attacks_2025_${quarterSelect.value}.geojson`;
    }
    return (viewSelect.value === "raw")
      ? "./data/attacks_2026_raw.geojson"
      : "./data/attacks_2026_live.geojson";
  }

  function passesRegion(lat, lon){
    const box = REGIONS[regionSelect.value];
    if (!box) return true;
    return (lat >= box.latMin && lat <= box.latMax && lon >= box.lonMin && lon <= box.lonMax);
  }

  // Map (Esri satellite)
  const map = L.map('map').setView([20,0],2);
  L.tileLayer(
    "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
    { maxZoom: 18, attribution: "Tiles &copy; Esri" }
  ).addTo(map);

  let clusterLayer = null;
  let chart = null;
  let currentFeatures = [];

  function updateChart(counts){
    const labels = ["assault","fight","mass_violence","other"];
    const data = [
      counts.assault || 0,
      counts.fight || 0,
      counts.mass_violence || 0,
      counts.other || 0
    ];

    if (!chart){
      chart = new Chart(document.getElementById("typeChart"), {
        type: "bar",
        data: { labels, datasets: [{ label: "Esem√©nyek", data }] },
        options: {
          responsive: false,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    } else {
      chart.data.labels = labels;
      chart.data.datasets[0].data = data;
      chart.update();
    }
  }

  function guessCountryFromLocation(loc){
    if (!loc) return "Unknown";
    const parts = loc.split(",").map(s => s.trim()).filter(Boolean);
    return parts.length ? parts[parts.length - 1] : "Unknown";
  }

  function render(){
    if (clusterLayer) map.removeLayer(clusterLayer);
    clusterLayer = L.markerClusterGroup({
      showCoverageOnHover: false,
      spiderfyOnMaxZoom: true,
      disableClusteringAtZoom: 10
    });

    const counts = {assault:0, fight:0, mass_violence:0, other:0};
    let shown = 0;
    let sourcesTotal = 0;
    const countryCounts = new Map();

    for (const f of currentFeatures){
      const c = (f.geometry || {}).coordinates || [];
      if (c.length < 2) continue;
      const lon = c[0], lat = c[1];
      if (!passesRegion(lat, lon)) continue;

      const p = f.properties || {};
      const t = p.attack_type || "other";

      if (t === "assault") counts.assault++;
      else if (t === "fight") counts.fight++;
      else if (t === "mass_violence") counts.mass_violence++;
      else counts.other++;

      const srcs = getSources(p);
      sourcesTotal += srcs.length;

      const country = guessCountryFromLocation(p.location || "");
      countryCounts.set(country, (countryCounts.get(country) || 0) + 1);

      const m = L.marker([lat, lon]);
      m.bindPopup(popupHtml(p));
      clusterLayer.addLayer(m);
      shown++;
    }

    map.addLayer(clusterLayer);

    statScope.textContent = scopeLabel();
    statRegion.textContent = regionLabel(regionSelect);
    statPoints.textContent = String(shown);
    statSources.textContent = String(sourcesTotal);

    updateChart(counts);

    topCountriesEl.innerHTML = "";
    const top = Array.from(countryCounts.entries()).sort((a,b)=>b[1]-a[1]).slice(0,5);
    for (const [country, n] of top){
      const li = document.createElement("li");
      li.innerHTML = `${escapeHtml(country)} <span class="pill">${n}</span>`;
      topCountriesEl.appendChild(li);
    }

    setStatusOk(`OK: ${scopeLabel()} ‚Ä¢ R√©gi√≥: ${regionLabel(regionSelect)} ‚Ä¢ Pontok: ${shown}`);
  }

  async function loadData(){
    try{
      setControls();
      setStatusOk("Bet√∂lt√©s‚Ä¶");
      const url = dataUrl();
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) throw new Error(`Nem tal√°lom az adatf√°jlt: ${url} (HTTP ${r.status})`);
      const data = await r.json();
      currentFeatures = data.features || [];
      render();
    } catch(e){
      setStatusErr("HIBA: " + e.message);
    }
  }

  // Sync embed controls
  function cloneOptions(fromSel, toSel){
    toSel.innerHTML = "";
    for (const opt of fromSel.options){
      const o = document.createElement("option");
      o.value = opt.value;
      o.textContent = opt.textContent;
      if (opt.selected) o.selected = true;
      toSel.appendChild(o);
    }
  }
  function syncMainToEmbed(){
    if (!EMBED) return;
    cloneOptions(yearSelect, yearSelectEmbed);
    cloneOptions(quarterSelect, quarterSelectEmbed);
    cloneOptions(viewSelect, viewSelectEmbed);
    cloneOptions(regionSelect, regionSelectEmbed);
    setControls();
  }

  // Main events
  yearSelect.addEventListener("change", () => {
    if (yearSelect.value === "2025") quarterSelect.value = "Q4";
    else viewSelect.value = "live";
    syncMainToEmbed();
    loadData();
  });
  quarterSelect.addEventListener("change", () => { syncMainToEmbed(); loadData(); });
  viewSelect.addEventListener("change", () => { syncMainToEmbed(); loadData(); });
  regionSelect.addEventListener("change", () => { syncMainToEmbed(); render(); });

  // Embed events -> update main -> load/render
  if (EMBED){
    syncMainToEmbed();

    yearSelectEmbed.addEventListener("change", () => {
      yearSelect.value = yearSelectEmbed.value;
      if (yearSelect.value === "2025") quarterSelect.value = "Q4";
      else viewSelect.value = "live";
      syncMainToEmbed();
      loadData();
    });

    quarterSelectEmbed.addEventListener("change", () => {
      quarterSelect.value = quarterSelectEmbed.value;
      syncMainToEmbed();
      loadData();
    });

    viewSelectEmbed.addEventListener("change", () => {
      viewSelect.value = viewSelectEmbed.value;
      syncMainToEmbed();
      loadData();
    });

    regionSelectEmbed.addEventListener("change", () => {
      regionSelect.value = regionSelectEmbed.value;
      syncMainToEmbed();
      render();
    });

    panelToggle.addEventListener("click", () => {
      panel.classList.toggle("hidden");
    });
  }

  loadData();
</script>

</body>
</html>
