<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OSINT Armed Attacks Map</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">

  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, Arial; }

    header{
      height: 110px;
      padding: 10px 12px;
      border-bottom: 1px solid #ddd;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      box-sizing:border-box;
      gap:12px;
    }
    .title{ font-size:18px; font-weight:800; }
    .right{ display:flex; gap:10px; flex-wrap:wrap; }

    #status{
      padding: 8px 12px;
      font-size: 13px;
      border-bottom: 1px solid #eee;
      background: #fafafa;
    }

    #content{
      height: calc(100% - 110px - 41px);
      display:flex;
    }

    #map{ flex:1; }

    #panel{
      width: 340px;
      border-left:1px solid #eee;
      padding:10px;
      background:white;
    }
  </style>
</head>
<body>

<header>
  <div class="title">OSINT fegyveres incidensek térképe</div>

  <div class="right">
    <select id="yearSelect">
      <option value="2025" selected>2025</option>
      <option value="2026">2026</option>
    </select>

    <select id="quarterSelect">
      <option value="Q1">Q1</option>
      <option value="Q2">Q2</option>
      <option value="Q3">Q3</option>
      <option value="Q4" selected>Q4</option>
    </select>

    <select id="viewSelect" style="display:none;">
      <option value="live">LIVE</option>
      <option value="raw">RAW</option>
    </select>

    <select id="regionSelect">
      <option value="global">Világ</option>
      <option value="europe">Európa</option>
      <option value="eastern_europe">Kelet-Európa</option>
      <option value="balkans">Balkán</option>
      <option value="middle_east">Közel-Kelet</option>
    </select>
  </div>
</header>

<div id="status">Betöltés…</div>

<div id="content">
  <div id="map"></div>
  <div id="panel">
    <canvas id="typeChart" width="300" height="200"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
const map = L.map('map').setView([20,0],2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let clusterLayer = null;
let chart = null;
let currentFeatures = [];

const REGIONS = {
  global:null,
  europe:{latMin:35,latMax:72,lonMin:-25,lonMax:45},
  eastern_europe:{latMin:44,latMax:65,lonMin:20,lonMax:60},
  balkans:{latMin:37,latMax:48,lonMin:13,lonMax:30},
  middle_east:{latMin:12,latMax:42,lonMin:25,lonMax:70}
};

function dataUrl(){
  const year = yearSelect.value;
  if(year==="2025") return `./data/attacks_2025_${quarterSelect.value}.geojson`;
  return viewSelect.value==="raw"
    ? "./data/attacks_2026_raw.geojson"
    : "./data/attacks_2026_live.geojson";
}

function passesRegion(lat,lon){
  const r = REGIONS[regionSelect.value];
  if(!r) return true;
  return lat>=r.latMin && lat<=r.latMax && lon>=r.lonMin && lon<=r.lonMax;
}

function render(){
  if(clusterLayer) map.removeLayer(clusterLayer);
  clusterLayer=L.markerClusterGroup();

  const typeCounts={};

  for(const f of currentFeatures){
    const c=f.geometry.coordinates;
    const lat=c[1],lon=c[0];
    if(!passesRegion(lat,lon)) continue;

    const p=f.properties||{};
    const type=p.attack_type||"other";

    typeCounts[type]=(typeCounts[type]||0)+1;

    const m=L.marker([lat,lon]);
    m.bindPopup(p.location+"<br>"+p.date);
    clusterLayer.addLayer(m);
  }

  map.addLayer(clusterLayer);

  updateChart(typeCounts);
}

function updateChart(counts){
  const labels=Object.keys(counts);
  const data=Object.values(counts);

  if(!chart){
    chart=new Chart(typeChart,{type:"bar",
      data:{labels,datasets:[{data}]},
      options:{responsive:false}
    });
  }else{
    chart.data.labels=labels;
    chart.data.datasets[0].data=data;
    chart.update();
  }
}

async function loadData(){
  const r=await fetch(dataUrl());
  const data=await r.json();
  currentFeatures=data.features||[];
  render();
  status.innerText="Betöltve: "+currentFeatures.length+" pont";
}

yearSelect.onchange=()=>{
  viewSelect.style.display=yearSelect.value==="2026"?"":"none";
  quarterSelect.style.display=yearSelect.value==="2025"?"":"none";
  loadData();
};

quarterSelect.onchange=loadData;
viewSelect.onchange=loadData;
regionSelect.onchange=render;

loadData();
</script>

</body>
</html>
