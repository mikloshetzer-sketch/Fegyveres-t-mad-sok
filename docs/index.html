<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OSINT Armed Attacks Map</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">

  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, Arial; }

    header{
      height: 96px;
      padding: 10px 12px;
      border-bottom: 1px solid #ddd;
      display:flex;
      align-items:center;
      justify-content:space-between;
      box-sizing:border-box;
      gap:12px;
    }
    .left{ display:flex; flex-direction:column; gap:4px; }
    .title{ font-size:18px; font-weight:800; line-height:1.1; }
    .subtitle{ font-size:12px; opacity:.8; }

    .right{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:14px;
      white-space:nowrap;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    select{ padding:6px 8px; font-size:14px; }

    #status{
      padding: 8px 12px;
      font-size: 13px;
      border-bottom: 1px solid #eee;
      background: #fafafa;
    }
    #status.ok{ color:#0a7a2f; }
    #status.err{ color:#b00020; }

    #map{ height: calc(100% - 96px - 41px); background:#f3f3f3; }

    .src-list { margin: 6px 0 0 0; padding-left: 18px; }
    .src-list li { margin: 4px 0; }
    .hint { font-size: 12px; opacity: .75; margin-left: 6px; }
  </style>
</head>
<body>

<header>
  <div class="left">
    <div class="title">OSINT fegyveres incidensek térképe</div>
    <div class="subtitle">2025: negyedévek (Q1–Q4) • 2026: LIVE / Részletes (14 nap)</div>
  </div>

  <div class="right">
    <label for="yearSelect">Év:</label>
    <select id="yearSelect">
      <option value="2025" selected>2025</option>
      <option value="2026">2026</option>
    </select>

    <label for="quarterSelect" id="quarterLabel">Negyedév:</label>
    <select id="quarterSelect">
      <option value="Q1">Q1</option>
      <option value="Q2">Q2</option>
      <option value="Q3">Q3</option>
      <option value="Q4" selected>Q4</option>
    </select>

    <label for="viewSelect" id="viewLabel" style="display:none;">Nézet:</label>
    <select id="viewSelect" style="display:none;">
      <option value="live" selected>LIVE</option>
      <option value="raw">Részletes</option>
    </select>
    <span class="hint" id="viewHint" style="display:none;">(csak 2026-nál)</span>
  </div>
</header>

<div id="status">Betöltés…</div>
<div id="map"></div>

<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
  const statusEl = document.getElementById("status");
  const yearSelect = document.getElementById("yearSelect");
  const quarterSelect = document.getElementById("quarterSelect");
  const quarterLabel = document.getElementById("quarterLabel");
  const viewSelect = document.getElementById("viewSelect");
  const viewLabel = document.getElementById("viewLabel");
  const viewHint  = document.getElementById("viewHint");

  function setStatusOk(msg){ statusEl.className="ok"; statusEl.textContent=msg; }
  function setStatusErr(msg){ statusEl.className="err"; statusEl.textContent=msg; }

  let map = L.map('map').setView([20, 0], 2);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  let currentLayer = null;

  function escapeHtml(s) {
    return (s || "").toString()
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function getSources(p){
    const list = [];
    if (Array.isArray(p.sources)) {
      for (const u of p.sources) if (u && !list.includes(u)) list.push(u);
    }
    if (p.sourceurl && !list.includes(p.sourceurl)) list.push(p.sourceurl);
    return list;
  }

  function makePopupHtml(p){
    const date = escapeHtml(p.date || "-");
    const loc  = escapeHtml(p.location || "-");
    const type = escapeHtml(p.attack_type || "-");

    const sources = getSources(p);
    const sourcesCount =
      (typeof p.sources_count === "number") ? p.sources_count :
      sources.length;

    let sourcesHtml = `<div><b>Források:</b> ${sourcesCount || 0}</div>`;
    if (sources.length > 0) {
      const items = sources.slice(0, 8).map((u, i) =>
        `<li><a href="${u}" target="_blank" rel="noopener">Forrás ${i+1}</a></li>`
      ).join("");
      sourcesHtml += `<ul class="src-list">${items}</ul>`;
    }

    return `
      <b>Esemény</b><br>
      Dátum: ${date}<br>
      Helyszín: ${loc}<br>
      Típus: ${type}<br>
      ${sourcesHtml}
    `;
  }

  function setControls(){
    const year = yearSelect.value;
    const is2025 = (year === "2025");
    const is2026 = (year === "2026");

    // 2025: negyedév látszik
    quarterSelect.style.display = is2025 ? "" : "none";
    quarterLabel.style.display  = is2025 ? "" : "none";

    // 2026: nézet (live/raw) látszik
    viewSelect.style.display = is2026 ? "" : "none";
    viewLabel.style.display  = is2026 ? "" : "none";
    viewHint.style.display   = is2026 ? "" : "none";
  }

  function dataUrl(){
    const year = yearSelect.value;
    if (year === "2025"){
      const q = quarterSelect.value;
      return `./data/attacks_2025_${q}.geojson`;
    }
    // 2026
    const view = viewSelect.value;
    return (view === "raw")
      ? "./data/attacks_2026_raw.geojson"
      : "./data/attacks_2026_live.geojson";
  }

  async function loadLayer(){
    try{
      setControls();

      if (currentLayer){
        map.removeLayer(currentLayer);
        currentLayer = null;
      }

      const url = dataUrl();
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) throw new Error(`Nem találom az adatfájlt: ${url} (HTTP ${r.status})`);

      const data = await r.json();
      const features = data.features || [];
      const count = features.length;

      // ✅ Mindkét év: CLUSTER + spiderfy (szétesős buborék)
      const cluster = L.markerClusterGroup({
        showCoverageOnHover: false,
        spiderfyOnMaxZoom: true,
        disableClusteringAtZoom: 10
      });

      for (const f of features){
        const c = (f.geometry || {}).coordinates || [];
        if (c.length < 2) continue;
        const lon = c[0], lat = c[1];
        const p = f.properties || {};
        const m = L.marker([lat, lon]);
        m.bindPopup(makePopupHtml(p));
        cluster.addLayer(m);
      }

      currentLayer = cluster;
      map.addLayer(cluster);

      const year = yearSelect.value;
      if (year === "2025"){
        setStatusOk(`OK: 2025 ${quarterSelect.value} betöltve (${count} pont).`);
      } else {
        const label = (viewSelect.value === "raw") ? "Részletes" : "LIVE";
        setStatusOk(`OK: 2026 betöltve (${count} pont) — Nézet: ${label}.`);
      }

    } catch(e){
      setStatusErr("HIBA: " + e.message);
    }
  }

  // init
  setControls();
  loadLayer();

  yearSelect.addEventListener("change", () => {
    if (yearSelect.value === "2025"){
      // 2025-nél alap: Q4
      quarterSelect.value = "Q4";
    } else {
      // 2026-nál alap: LIVE
      viewSelect.value = "live";
    }
    loadLayer();
  });

  quarterSelect.addEventListener("change", loadLayer);
  viewSelect.addEventListener("change", loadLayer);
</script>

</body>
</html>
